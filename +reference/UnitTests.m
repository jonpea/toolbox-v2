classdef UnitTests < matlab.unittest.TestCase
    
    properties (ClassSetupParameter)
        generator = {'twister'}
    end
    
    properties (MethodSetupParameter)
        seed = {0}
    end
    
    properties (TestParameter)
        numDimensions = {2, 3}
        className = {'single', 'double'}
        numPoints = {0, 1, 5}
        numFaces = {0, 1, 5}
    end
    
    methods (TestClassSetup)
        function ClassSetup(testCase, generator)
            originalstate = rng;
            testCase.addTeardown(@rng, originalstate)
            rng(0, generator)
        end
    end
    
    methods (TestMethodSetup)
        function MethodSetup(testCase, seed)
            originalstate = rng;
            testCase.addTeardown(@rng, originalstate)
            rng(seed) % retains generator previously specified in constructor
        end
    end
    
    methods (Test, ParameterCombination = 'exhaustive')
        
        function mirrorTest(testcase, numPoints, numDimensions, className)
            point = rand(numPoints, numDimensions, className); % arbitrary point
            normal = unitrows(randn(1, numDimensions, className)); % normal to hyperplane
            offset = -ones(className); % arbitrary value (distinct from 0 and 1, say)
            mirrored = reference.mirror(point, normal, offset);
            projected = 0.5*(point + mirrored); % projection of point onto hyperplane
            direction = unitrows(point - mirrored); % direction of projection
            testcase.verifyEqual( ...
                abs(dotrows(normal, direction)), ...
                ones(numPoints, 1, className), ...
                'RelTol', relTol(className), ...
                'Vector connecting point to mirror/projection must align with normal vector')
            testcase.verifyEqual( ...
                dotrows(normal, projected), ...
                repmat(offset, numPoints, 1), ...
                'RelTol', relTol(className), ...
                'Projected point must satisfy characteristic equation of hyperplane')
        end
        
        function frameLineTest(testcase, numFaces, className)
            
            twodimensions = 2;
            numverticesperface = 2;
            
            randompoint = @() rand(numFaces, twodimensions, className);
            vertices = [ randompoint(); randompoint() ];
            faces = reshape(1 : numFaces*numverticesperface, numverticesperface, [])';
            
            [origin, normal, tangent, map] = reference.frames(faces, vertices);
            
            testcase.verifySize(origin, [numFaces, twodimensions])
            testcase.verifySize(normal, [numFaces, twodimensions])
            testcase.verifySize(tangent, [numFaces, twodimensions])
            testcase.verifySize(map, [numFaces, twodimensions])
            
            % ****
            map2 = facevertex.faceMap(faces, vertices);
            testcase.verifyEqual(map, map2);
            
            testcase.verifyEqual( ...
                normrows(normal), ...
                ones(numFaces, 1, className), ...
                'RelTol', relTol(className), ...
                'Unit normal vector must have unit length')
            
            testcase.verifyEqual( ...
                mapOffset(normal, map), ...
                zeros(numFaces, 1, className), ...
                'AbsTol', absTol(className), ...
                'Normal vector is orthogonal to coordinate maps')
            
            testcase.verifyEqual( ...
                mapOffset(normal, tangent), ...
                zeros(numFaces, 1, className), ...
                'AbsTol', absTol(className), ...
                'Normal vector is orthogonal to tangent vectors')

            function local = localcoordinate(vertexid)
                vertex = vertices(faces(:, vertexid), :);
                local = mapOffset(vertex - origin, map);
            end
            
            testcase.verifyEqual( ...
                localcoordinate(1), ...
                zeros(numFaces, 1, className), ...
                'AbsTol', absTol(className), ...
                'First vertex maps to 0')
            
            testcase.verifyEqual( ...
                localcoordinate(2), ...
                ones(numFaces, 1, className), ...
                'AbsTol', absTol(className), ...
                'Second vertex maps to 1')
            
        end
        
        function frameParallelogramTest(testcase, numFaces, className)
            
            threedimensions = 3;
            numverticesperface = 4;
            
            randompoint = @() rand(numFaces, threedimensions, className);
            faceorigin = randompoint(); % origin
            facetip1 = randompoint(); % tip of first axis
            facetip2 = randompoint(); % tip of second axis
            vertices = reshape([
                faceorigin, ...
                facetip1, ...
                facetip1 + facetip2 - faceorigin, ... % "p0 + (p1-p0) + (p2-p0)"
                facetip2
                ]', threedimensions, [])';
            faces = reshape( ...
                1 : numFaces*numverticesperface, ...
                numverticesperface, [])';
            
            [origin, normal, tangents, map] = reference.frames(faces, vertices);
            
            testcase.verifySize(origin, [numFaces, threedimensions])
            testcase.verifySize(normal, [numFaces, threedimensions])
            testcase.verifySize(tangents, [numFaces, threedimensions, threedimensions - 1])
            testcase.verifySize(map, [numFaces, threedimensions, threedimensions - 1])
            
            % ****
            map2 = facevertex.faceMap(faces, vertices);
            testcase.verifyEqual(map, map2);

            testcase.verifyEqual( ...
                normrows(normal), ...
                ones(numFaces, 1, className), ...
                'RelTol', relTol(className), ...
                'Unit normal vector must have unit length')
            
            testcase.verifyEqual( ...
                mapOffset(normal, map), ...
                zeros(numFaces, threedimensions - 1, className), ...
                'AbsTol', absTol(className), ...
                'Normal vector is orthogonal to coordinate maps')
            
            testcase.verifyEqual( ...
                mapOffset(normal, tangents), ...
                zeros(numFaces, threedimensions - 1, className), ...
                'AbsTol', absTol(className), ...
                'Normal vector is orthogonal to tangent vectors')

            function local = vertexlocalcoordinate(vertexid)
                vertex = vertices(faces(:, vertexid), :);
                local = mapOffset(vertex - origin, map);
            end
            
            function e = elemental(varargin)
                e = zeros(numFaces, threedimensions - 1, className);
                e(:, cell2mat(varargin)) = ones(className);
            end
            
            testcase.verifyEqual( ...
                vertexlocalcoordinate(1), ...
                elemental(), ...
                'AbsTol', absTol(className), ...
                'First vertex maps to [0, 0]')
            
            testcase.verifyEqual( ...
                vertexlocalcoordinate(2), ...
                elemental(1), ...
                'AbsTol', absTol(className), ...
                'Second vertex maps to [1, 0]')
            
            testcase.verifyEqual( ...
                vertexlocalcoordinate(3), ...
                elemental(1, 2), ...
                'AbsTol', absTol(className), ...
                'Third vertex maps to [1, 1]')
            
            testcase.verifyEqual( ...
                vertexlocalcoordinate(4), ...
                elemental(2), ...
                'AbsTol', absTol(className), ...
                'Fourth vertex maps to [0, 1]')
            
        end
        
        function frameTriangleTest(testcase, numFaces, className)
            
            threedimensions = 3;
            numverticesperface = 3;
            
            randompoint = @() rand(numFaces, threedimensions, className);
            vertices = [randompoint(); randompoint(); randompoint(); ];
            faces = reshape( ...
                1 : numFaces*numverticesperface, ...
                numverticesperface, [])';
            
            [origin, normal, tangents, map] = reference.frames(faces, vertices);
            
            testcase.verifySize(origin, [numFaces, threedimensions])
            testcase.verifySize(normal, [numFaces, threedimensions])
            testcase.verifySize(tangents, [numFaces, threedimensions, threedimensions - 1])
            testcase.verifySize(map, [numFaces, threedimensions, threedimensions - 1])

            % ****
            map2 = facevertex.faceMap(faces, vertices);
            testcase.verifyEqual(map, map2);

            testcase.verifyEqual( ...
                normrows(normal), ...
                ones(numFaces, 1, className), ...
                'RelTol', relTol(className), ...
                'Unit normal vector must have unit length')
            
            testcase.verifyEqual( ...
                mapOffset(normal, map), ...
                zeros(numFaces, threedimensions - 1, className), ...
                'AbsTol', absTol(className), ...
                'Normal vector is orthogonal to coordinate maps')

            testcase.verifyEqual( ...
                mapOffset(normal, tangents), ...
                zeros(numFaces, threedimensions - 1, className), ...
                'AbsTol', absTol(className), ...
                'Normal vector is orthogonal to tangent vectors')

            function rectangular = vertexlocalcoordinate(vertexid)
                vertex = vertices(faces(:, vertexid), :);
                rectangular = mapOffset(vertex - origin, map);
                % Note: "barycentric = [rectangular, 1 - sum(rectangular, 2)]"
            end
                        
            function e = elemental(varargin)
                % Rows of the identity matrix
                % e.g. "elemental(2)" replicates [0 1 0]
                e = zeros(numFaces, threedimensions - 1, className);
                e(:, cell2mat(varargin)) = ones(className);
            end
            
            testcase.verifyEqual( ...
                vertexlocalcoordinate(1), ...
                elemental(), ...
                'AbsTol', absTol(className), ...
                'First vertex maps to [0, 0]')
            
            testcase.verifyEqual( ...
                vertexlocalcoordinate(2), ...
                elemental(1), ...
                'AbsTol', absTol(className), ...
                'Second vertex maps to [1, 0]')
            
            testcase.verifyEqual( ...
                vertexlocalcoordinate(3), ...
                elemental(2), ...
                'AbsTol', absTol(className), ...
                'Third vertex maps to [0, 1]')
            
        end
                
    end
    
end

function tol = relTol(className)
tol = 10*eps(className);
end

function tol = absTol(className)
tol = 100*eps(className);
end

function rectangular = mapOffset(offset, map)
numDimensions = size(offset, 2);
rectangular = reshape(sum(offset.*map, 2), [], numDimensions - 1);
end
